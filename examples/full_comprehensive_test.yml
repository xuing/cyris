---
# Comprehensive CyRIS test configuration with all task types
# This version fixes all known issues in the original full.yml

- host_settings:
  - id: host_1
    mgmt_addr: localhost
    virbr_addr: 192.168.122.1
    account: ubuntu

- guest_settings:
  # Desktop VM with comprehensive task testing
  - id: desktop
    basevm_host: host_1
    basevm_config_file: /home/ubuntu/cyris/images/basevm.xml
    basevm_type: kvm

  # Webserver VM with package installation tasks
  - id: webserver
    basevm_host: host_1
    basevm_config_file: /home/ubuntu/cyris/images/basevm.xml
    basevm_type: kvm

  # Firewall VM with user management tasks
  - id: firewall
    basevm_host: host_1
    basevm_config_file: /home/ubuntu/cyris/images/basevm.xml
    basevm_type: kvm

- clone_settings:
  - range_id: comprehensive_test
    hosts:
    - host_id: host_1
      instance_number: 1
      guests:
      # Desktop VM: User management and attack emulation tasks
      - guest_id: desktop
        number: 1
        entry_point: yes
        tasks:
          # Test add_account with different user types
          - add_account:
              - account: testuser1
                passwd: password123
                full_name: "Test User One"
              - account: admin.user
                passwd: admin456
                full_name: "Admin User"
          
          # Test modify_account 
          - modify_account:
              - account: testuser1
                new_passwd: newpassword123
          
          # Test package installation (corrected for Ubuntu)
          - install_package:
              - package_manager: apt-get
                name: vim
              - package_manager: apt-get
                name: curl
              - package_manager: apt-get
                name: net-tools
          
          # Test attack emulation
          - emulate_attack:
              - attack_type: ssh_attack
                target_account: testuser1
                attempt_number: 50
                attack_time: "2024-01-01"
          
          # Test traffic capture
          - emulate_traffic_capture_file:
              - format: pcap
                file_name: /tmp/desktop_traffic.pcap
                attack_type: ssh_attack
                attack_source: 10.0.0.100
                noise_level: low
          
          # Test malware emulation
          - emulate_malware:
              - name: test_daemon
                mode: dummy_calculation
                cpu_utilization: 10

      # Webserver VM: Package installation and service setup
      - guest_id: webserver
        number: 1
        tasks:
          # Test user creation for web services
          - add_account:
              - account: webadmin
                passwd: webpass123
                full_name: "Web Administrator"
          
          # Test web server package installation
          - install_package:
              - package_manager: apt-get
                name: apache2
              - package_manager: apt-get
                name: php
              - package_manager: apt-get
                name: mysql-server
          
          # Test traffic capture for web services
          - emulate_traffic_capture_file:
              - format: pcap
                file_name: /tmp/web_traffic.pcap
                attack_type: ddos_attack
                noise_level: medium

      # Firewall VM: Advanced user management
      - guest_id: firewall
        number: 1
        tasks:
          # Test username with special characters (fixed in security.py)
          - add_account:
              - account: robot.firewall
                passwd: robotpass123
                full_name: "Robot Firewall User"
          
          # Test user modification
          - modify_account:
              - account: robot.firewall
                new_account: firewall.admin
                new_passwd: newfirewallpass

      topology:
      - type: custom
        networks:
        - name: office_network
          members: desktop.eth0
        - name: web_network
          members: webserver.eth0
        - name: firewall_network
          members: firewall.eth0